name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout source (for k8s manifests only)
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Install kubectl (stable + supported)
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: v1.29.0

      # 3️⃣ Configure Kubernetes access securely
      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config

      # 4️⃣ Create DockerHub image pull secret
      - name: Create DockerHub imagePullSecret
        run: |
          kubectl create secret docker-registry dockerhub-secret \
            --docker-username=${{ secrets.DOCKERHUB_USERNAME }} \
            --docker-password=${{ secrets.DOCKERHUB_TOKEN }} \
            --docker-server=https://index.docker.io/v1/ \
            --dry-run=client -o yaml | kubectl apply -f -

      # 5️⃣ Deploy application to Kubernetes
      - name: Deploy application
        run: |
          kubectl apply -f k8s/

      # 6️⃣ Verify rollout (mandatory production gate)
      - name: Verify deployment rollout
        run: |
          kubectl rollout status deployment/transaction-risk-service --timeout=120s
          kubectl get pods

      # 7️⃣ Dummy DAST / Runtime validation (guideline requirement)
      - name: Runtime health validation
        run: |
          SERVICE_IP=$(kubectl get svc transaction-risk-service \
            -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

          if [ -z "$SERVICE_IP" ]; then
            echo "Service IP not available yet"
            exit 1
          fi

          curl -f http://$SERVICE_IP/actuator/health
