name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout only for k8s manifests
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Install kubectl
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: v1.29.0

      # 3️⃣ Configure Kubernetes context securely
      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config

      # 4️⃣ Create / update DockerHub imagePullSecret
      - name: Create DockerHub image pull secret
        run: |
          kubectl create secret docker-registry dockerhub-secret \
            --docker-username=${{ secrets.DOCKERHUB_USERNAME }} \
            --docker-password=${{ secrets.DOCKERHUB_TOKEN }} \
            --docker-server=https://index.docker.io/v1/ \
            --dry-run=client -o yaml \
          | kubectl apply --validate=false -f -

      # 5️⃣ Deploy application manifests
      - name: Deploy to Kubernetes
        run: |
          kubectl apply --validate=false -f k8s/

      # 6️⃣ Verify deployment rollout
      - name: Verify rollout
        run: |
          kubectl rollout status deployment/transaction-risk-service --timeout=120s
          kubectl get pods

      # 7️⃣ Runtime validation (dummy DAST)
      - name: Runtime health check
        run: |
          kubectl port-forward svc/transaction-risk-service 8080:80 &
          sleep 10
          curl -f http://localhost:8080/actuator/health
